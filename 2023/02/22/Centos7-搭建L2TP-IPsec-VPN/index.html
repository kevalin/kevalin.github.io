<!DOCTYPE html>

<html lang="zh-CN">
    <head>
    <meta charset="utf-8">
    <!--
        hexo-theme-suka © SukkaW
        GitHub: https://github.com/SukkaW/hexo-theme-suka
    -->

    <!-- ### Resource Hint ### -->

    <!-- ## DNS Prefetch ## -->
    <meta http-equiv="x-dns-prefetch-control" content="on">

<!-- busuanzi -->

    <link rel="dns-prefetch" href="//busuanzi.ibruce.info">


<!-- comment -->


    <link rel="dns-prefetch" href="//disqus.com">
    <link rel="dns-prefetch" href="//kevalin-github-io-1.disqus.com">






<!-- analytics -->






    <link rel="dns-prefetch" href="//pingjs.qq.com">


    <!-- ## Preload ## -->
    
    <!-- Busuanzi -->
    
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" as="script">







    <!-- ### Meta & Title & Info ### -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <meta name="renderer" content="webkit">

    <!-- Title -->
    <title>Centos7 搭建L2TP+IPsec VPN | 举个栗子</title>

    <!-- Favicons -->
    <link rel="icon" type="image&#x2F;ico" href="/img/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png"><link rel="icon" typt="image&#x2F;png" sizes="192x192" href="/img/android-chrome-192x192.png"><link rel="icon" typt="image&#x2F;png" sizes="32x32" href="/img/favicon-32x32.png"><link rel="icon" typt="image&#x2F;png" sizes="16x16" href="/img/favicon-16x16.png"><link rel="mask-icon" href="/img/safari-pinned-tab.svg" color="">

    <!-- ### Import File ### -->
    <link rel="stylesheet" href="/lib/spectre/spectre.min.css"><style>
    body {
        background-color: #f8f9fa;
    }

    a, a:visited {
        color: #0070ff;
    }

    a:active, a:focus, a:hover {
        color: #0070ff;
        opacity: .75;
    }

    #post-content a,
    #post-content a:hover,
    #post-content a:focus,
    #post-content a:visited {
        color: #005eb9;
        opacity: 1;
    }

    

    .post-entry .card-body a {
        color: #0070ff;
    }

    .avatar {
        background: #444;
    }

    .navbar-link,
    .navbar-link:visited,
    .timeline .timeline-item .timeline-icon.icon-lg {
        color: #0070ff;
    }

    .navbar-link:hover {
        color: #0070ff;
        opacity: .8;
    }

    #search-input .btn,
    #disqus_click_btn,
    #disqus-switch-to-direct,
    #disqus-loadmore-button {
        background: #727e96;
        border-color: #727e96;
        color: #fff;
    }

    #post-toc a.post-toc-link,
    #post-toc a.post-toc-link:visited,
    .share-menu.menu .menu-item>a {
        color: #727e96;
    }

    .share-menu.menu .menu-item>a:hover,
    .share-menu.menu .menu-item>a:focus,
    .share-menu.menu .menu-item>a:visited {
        color: #50596c;
        background: #f8f9fa;
        opacity: .85;
    }
</style><link rel="stylesheet" href="/css/style.min.css">








    <!-- Prettify Theme -->
    
    <link rel="preload" href="/css/highlight/xcode.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/css/highlight/xcode.min.css"></noscript>





<script>
/*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
!function(t){"use strict";t.loadCSS||(t.loadCSS=function(){});var e=loadCSS.relpreload={};if(e.support=function(){var e;try{e=t.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),e.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.addEventListener?t.removeEventListener("load",a):t.attachEvent&&t.detachEvent("onload",a),t.setAttribute("onload",null),t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},e.poly=function(){if(!e.support())for(var a=t.document.getElementsByTagName("link"),n=0;n<a.length;n++){var o=a[n];"preload"!==o.rel||"style"!==o.getAttribute("as")||o.getAttribute("data-loadcss")||(o.setAttribute("data-loadcss",!0),e.bindMediaToggle(o))}},!e.support()){e.poly();var a=t.setInterval(e.poly,500);t.addEventListener?t.addEventListener("load",function(){e.poly(),t.clearInterval(a)}):t.attachEvent&&t.attachEvent("onload",function(){e.poly(),t.clearInterval(a)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:t.loadCSS=loadCSS}("undefined"!=typeof global?global:this);
</script>

    <!-- ### Site Verification ### -->
    


    <meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="举个栗子"><meta name="msapplication-starturl" content="https://kevalin.github.io"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="举个栗子"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- ### The Open Graph & Twitter Card Protocol ### -->
    <meta property="og:title" content="Centos7 搭建L2TP+IPsec VPN | 举个栗子"><meta property="og:site_name" content="举个栗子"><meta property="og:type" content="article"><meta property="og:url" content="https://kevalin.github.io/2023/02/22/Centos7-%E6%90%AD%E5%BB%BAL2TP-IPsec-VPN/"><meta property="og:locale" content="zh-CN"><meta name="description" content="Centos7 搭建L2TP+IPsec VPN L2TP是一种工业标准的Internet隧道协议，功能大致和PPTP协议类似，比如同样可以对网络数据流进行加密。 - Kevalin - 举个栗子"><meta name="keywords" content="Linux, VPN, node.js,Node.js,nodejs,Nodejs,javasript,Javascript,Linux,linux,mysql,Mysql"><meta property="og:image" content="https://images.unsplash.com/photo-1603985529862-9e12198c9a60?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8Mnx8dnBufGVufDB8fDB8fA==&auto=format&fit=crop&w=800&q=60"><meta property="article:published_time" content="2023-02-22T15:27:20.000Z"><meta property="article:modified_time" content="2023-02-22T15:59:44.148Z"><meta property="og:updated_time" content="2023-02-22T15:59:44.148Z"><meta property="article:author" content="Kevalin"><meta property="article:tag" content="Linux, VPN, node.js,Node.js,nodejs,Nodejs,javasript,Javascript,Linux,linux,mysql,Mysql"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://images.unsplash.com/photo-1603985529862-9e12198c9a60?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8Mnx8dnBufGVufDB8fDB8fA==&auto=format&fit=crop&w=800&q=60">

    

    <!-- ### Canonical link ### -->
    <link rel="canonical" href="https://kevalin.github.io/2023/02/22/Centos7-%E6%90%AD%E5%BB%BAL2TP-IPsec-VPN/">

    <meta name="generator" content="Hexo 5.4.0">

    <!-- ### Analytics ### -->
    





    <script>
    var _mtac = {};
    (function() {
        var mta = document.createElement("script");
        mta.src = "https://pingjs.qq.com/h5/stats.js?v2.0.4";
        mta.setAttribute("name", "MTAH5");
        mta.setAttribute("sid", "theme.analytics.tencent_mta_id");

        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(mta, s);
    })();
</script>



    <!-- ### Structured Data ### -->
    



<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "url": "https://kevalin.github.io/2023/02/22/Centos7-%E6%90%AD%E5%BB%BAL2TP-IPsec-VPN/",
    "@type": "BlogPosting",
    "logo": "https://kevalin.github.io/img/android-chrome-192x192.png",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://kevalin.github.io/2023/02/22/Centos7-%E6%90%AD%E5%BB%BAL2TP-IPsec-VPN/"
    },
    "headline": "Centos7 搭建L2TP+IPsec VPN | 举个栗子",
    
    "image": {
        "@type": "ImageObject",
        "url": "https://images.unsplash.com/photo-1603985529862-9e12198c9a60?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxzZWFyY2h8Mnx8dnBufGVufDB8fDB8fA%3D%3D&amp;auto=format&amp;fit=crop&amp;w=800&amp;q=60"
    },
    
    "datePublished": "2023-02-22T15:27:20.000Z",
    "dateModified": "2023-02-22T15:59:44.148Z",
    "author": {
        "@type": "Person",
        "name": "Kevalin",
        "image": {
            "@type": "ImageObject",
            "url": "https://avatars.githubusercontent.com/u/3123807"
        },
        "description": "好读书，不求甚解"
    },
    "publisher": {
        "@type": "Organization",
        "name": "举个栗子",
        "logo": {
            "@type": "ImageObject",
            "url": "https://kevalin.github.io/img/android-chrome-192x192.png"
        }
    },
    
    "potentialAction": {
        "@type": "SearchAction",
        "target": "https://kevalin.github.io/search?s={search_term_string}",
        "query-input": "required name=search_term_string"
    },
    
    "keywords": "Linux, VPN, node.js,Node.js,nodejs,Nodejs,javasript,Javascript,Linux,linux,mysql,Mysql",
    "description": "Centos7 搭建L2TP+IPsec VPN L2TP是一种工业标准的Internet隧道协议，功能大致和PPTP协议类似，比如同样可以对网络数据流进行加密。 - Kevalin - 举个栗子"
}
</script>



    <!-- ### Custom Head ### -->
    
</head>

    <body>
            

            <!-- ### Main content ### -->
            <!-- ## Header ##-->
<header>
    <h1 class="header-title text-center"><a href="/">举个栗子</a></h1>

    <p class="text-center header-slogan">
        
            
                好读书，不求甚解
            
        
    </p>

    <nav class="navbar-section text-center">
    
        <a href="/" class="navbar-link">首页</a>
    
    
        <a href="/archives/" class="navbar-link">归档</a>
    
    
        <a href="/search" class="navbar-link">搜索</a>
    
    
        <a href="/tags/" class="navbar-link">标签</a>
    
        <a href="/about/" class="navbar-link">关于</a>
    
        <a href="/links/" class="navbar-link">友链</a>
    
    
    
</nav>
</header>

            
    <!-- ## Post ## -->
    <div class="post-container">
    <div id="post-card" class="card">
        
            <div class="card-image lazyload" data-bg="url('https://images.unsplash.com/photo-1603985529862-9e12198c9a60?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxzZWFyY2h8Mnx8dnBufGVufDB8fDB8fA%3D%3D&amp;auto=format&amp;fit=crop&amp;w=800&amp;q=60')"></div>
        
        <div class="card-item-container">
            <div class="card-inner-cell">
                <!-- # Post Header Info # -->
                <div class="card-header">
                    
    <h1 class="card-title h3 mb-2">Centos7 搭建L2TP+IPsec VPN</h1>




<div class="post-header-info">
    <p class="post-header-info-left text-gray">
        <img class="author-thumb lazyload" data-src="https://avatars.githubusercontent.com/u/3123807" src="/img/suka-lazyload.gif" alt="Kevalin's Avatar">
        <span>2023-02-22</span>
        
        
            <!-- Busuanzi Post Views -->
<span id="busuanzi_container_page_pv" hidden>
    <span class="suka-devide-dot"></span>
    <span></span>
    <span id="busuanzi_value_page_pv"></span>
    <span>Views</span>
</span>
        
        
    </p>
    <div class="post-header-info-right">
        
            <div class="dropdown dropdown-right">
<a class="dropdown-toggle" tabindex="0">分享本文</a>
<ul class="menu share-menu">
    <!-- Share Weibo -->
    

    <!-- Share Twitter -->
    
    <li class="menu-item">
        <a href="https://twitter.com/intent/tweet?text=Centos7 搭建L2TP+IPsec VPN&url=https://kevalin.github.io/2023/02/22/Centos7-%E6%90%AD%E5%BB%BAL2TP-IPsec-VPN/&via=Kevalin" target="_blank" rel="external noopener noreferrer nofollow">分享到 Twitter</a>
    </li>
    

    <!-- Share Facebook -->
    
    <li class="menu-item">
        <a href="https://www.facebook.com/sharer/sharer.php?u=https://kevalin.github.io/2023/02/22/Centos7-%E6%90%AD%E5%BB%BAL2TP-IPsec-VPN/" target="_blank" rel="external noopener noreferrer nofollow">分享到 Facebook</a>
    </li>
    

    <!-- Share Google+ -->
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
    <li class="menu-item">
        <a href="https://t.me/share/url?url=https://kevalin.github.io/2023/02/22/Centos7-%E6%90%AD%E5%BB%BAL2TP-IPsec-VPN/&text=举个栗子" target="_blank" rel="external noopener noreferrer nofollow">分享到 Telegram</a>
    </li>
    

    <!-- QRCode -->
    
    <li class="menu-item">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKQAAACkCAAAAAA83tqdAAACJ0lEQVR42u2aQY4CMRAD+f+nd08rIcS0q0cg2HHlgoAhqRw6OHbffv7BuAkppJBCfgHkbRh/348T3T13/+zj7599P60rZDdkWnx69nFDaZNp80IK+WyBo8+PFkwbmzY8bUpIIacJyWF8NA855IUUcls49LAnh7SQQhJIOikBIiLlpSpIyMtBkovYO15fflsU8hKQyDgKF/wtzFtcNSEvA0lNJCpck0iZ5kKGlZAVkOTyTw/pI/ExrXFobglZCTkVUFo8HebJOEjiWshOyE3AlMysCYBc2laHuZCXhqSFkzZGjVdi+AvZC5nCTRJ0ToVERMxhoQpZCUnCpU3xbELPU+mDkDWQybxPRn+abyuGheyFpMJhKopJSGx+EwWGkLWQSWTQAqONUIfBv5CVkLRQaKiUQgJqygrZC3lGTJAQiTbirc0BIS8POYHRBruz4XwK64XshiRg5H0Sv8QwELIbMv3hk+LYNDttilLIXsgUXKbmpI04JsGpkN2QG2OKbooe3smcEFLIrbAgJikRLasAVMgKyHRJT6E9DZLWRoKQtZAkwCSB/TYwjcG/kEIGEUGbkycQIqCF7IZMY2Pqp+biNJ+QQibDPQWdE+SZwBOltEJWQBIjdCuOU+iJGvqErIbcNIQkgyuZpal5REghaQBELmnbcGBcQ0ghwaWfillqHIzrClkNSRelBRVNeyKchayFpBex1CySio2G+0J2Q37zEFJIIYX84PgF4kAWRBqsABsAAAAASUVORK5CYII=" alt="QRCode">
    </li>
    

</ul>
</div>
        
    </div>
</div>
                </div>
                <div class="card-body">
                    
                    <article id="post-content">
                        <h1 id="Centos7-搭建L2TP-IPsec-VPN"><a href="#Centos7-搭建L2TP-IPsec-VPN" class="headerlink" title="Centos7 搭建L2TP+IPsec VPN"></a>Centos7 搭建L2TP+IPsec VPN</h1><blockquote>
<p>L2TP是一种工业标准的Internet隧道协议，功能大致和PPTP协议类似，比如同样可以对网络数据流进行加密。<span id="more"></span>不过也有不同之处，比如PPTP要求网络为IP网络，L2TP要求面向数据包的点对点连接；PPTP使用单一隧道，L2TP使用多隧道；L2TP提供包头压缩、隧道验证，而PPTP不支持。L2TP本身不提供加密功能, 经常搭配IPsec加密协议一起使用, 可以提供比PPTP更高级别的数据加密。</p>
</blockquote>
<h2 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h2><p>检查L2TP需要的环境支持</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看主机是否支持pptp，返回结果为yes就表示通过</span></span><br><span class="line">modprobe ppp-compress-18 &amp;&amp; <span class="built_in">echo</span> yes</span><br><span class="line"><span class="comment"># 查看是否开启了TUN</span></span><br><span class="line"><span class="comment"># 有的虚拟机主机需要开启，返回结果为cat: /dev/net/tun: File descriptor in bad state或cat: /dev/net/tun: 文件描述符处于错误状态。就表示通过。</span></span><br><span class="line">cat /dev/net/tun</span><br></pre></td></tr></table></figure>

<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>需要安装的软件</p>
<ul>
<li>ppp: 提供用户名密码验证功能，实现 VPN 的用户账号密码验证 (Centos7.x已经自带)</li>
<li>libreswan: 提供 IPsec 功能，加密 IP 数据包</li>
<li>xl2tpd: 提供 VPN 功能，依赖于 ppp 和 libreswan</li>
</ul>
<p>开始安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先更新</span></span><br><span class="line">yum install update</span><br><span class="line">yum update -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装EPEL源，因为CentOS7官方源中已经去掉了xl2tpd</span></span><br><span class="line">yum install -y epel-release</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装xl2tpd和libreswan（libreswan用以实现IPSec，原先的openswan已经停止维护）</span></span><br><span class="line">yum install -y xl2tpd libreswan lsof</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装iptables防火墙，一般都有自带</span></span><br><span class="line">yum install iptables</span><br></pre></td></tr></table></figure>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="xl2tpd"><a href="#xl2tpd" class="headerlink" title="xl2tpd"></a>xl2tpd</h3><p>配置文件<code>/etc/xl2tpd/xl2tpd.conf</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">;</span><br><span class="line">; This is a minimal sample xl2tpd configuration file <span class="keyword">for</span> use</span><br><span class="line">; with L2TP over IPsec.</span><br><span class="line">;</span><br><span class="line">; The idea is to provide an L2TP daemon to <span class="built_in">which</span> remote Windows L2TP/IPsec</span><br><span class="line">; clients connect. In this example, the internal (protected) network </span><br><span class="line">; is 192.168.1.0/24.  A special IP range within this network is reserved</span><br><span class="line">; <span class="keyword">for</span> the remote clients: 192.168.1.128/25</span><br><span class="line">; (i.e. 192.168.1.128 ... 192.168.1.254)</span><br><span class="line">;</span><br><span class="line">; The listen-addr parameter can be used <span class="keyword">if</span> you want to <span class="built_in">bind</span> the L2TP daemon</span><br><span class="line">; to a specific IP address instead of to all interfaces. For instance,</span><br><span class="line">; you could <span class="built_in">bind</span> it to the interface of the internal LAN (e.g. 192.168.1.98</span><br><span class="line">; <span class="keyword">in</span> the example below). Yet another IP address (<span class="built_in">local</span> ip, e.g. 192.168.1.99)</span><br><span class="line">; will be used by xl2tpd as its address on pppX interfaces.</span><br><span class="line"></span><br><span class="line">[global]</span><br><span class="line">; listen-addr = 172.16.0.12 <span class="comment"># 这里我使用了默认配置, 也就是绑定端口到0.0.0.0</span></span><br><span class="line">;</span><br><span class="line">; requires openswan-2.5.18 or higher - Also does not yet work <span class="keyword">in</span> combination</span><br><span class="line">; with kernel mode l2tp as present <span class="keyword">in</span> linux 2.6.23+</span><br><span class="line">ipsec saref = yes</span><br><span class="line">; Use refinfo of 22 <span class="keyword">if</span> using an SAref kernel patch based on openswan 2.6.35 or</span><br><span class="line">;  when using any of the SAref kernel patches <span class="keyword">for</span> kernels up to 2.6.35.</span><br><span class="line">; saref refinfo = 30</span><br><span class="line">;</span><br><span class="line">; force userspace = yes</span><br><span class="line">;</span><br><span class="line">; debug tunnel = yes</span><br><span class="line">auth file = /etc/ppp/chap-secrets</span><br><span class="line">port = 1701</span><br><span class="line"></span><br><span class="line">[lns default]</span><br><span class="line">ip range = 192.168.100.128-192.168.100.254 <span class="comment"># 设置的vpn客户端IP地址段</span></span><br><span class="line"><span class="built_in">local</span> ip = 192.168.100.1 <span class="comment"># 本机分配的vpn IP地址, 保持同一个段</span></span><br><span class="line">require chap = yes</span><br><span class="line">refuse pap = yes</span><br><span class="line">require authentication = yes</span><br><span class="line">name = LinuxVPNserver</span><br><span class="line">ppp debug = yes</span><br><span class="line">pppoptfile = /etc/ppp/options.xl2tpd</span><br><span class="line">length bit = yes</span><br></pre></td></tr></table></figure>

<h3 id="ppp"><a href="#ppp" class="headerlink" title="ppp"></a>ppp</h3><p>配置文件<code>/etc/ppp/options.xl2tpd</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">ipcp-accept-local</span><br><span class="line">ipcp-accept-remote</span><br><span class="line">ms-dns  8.8.8.8</span><br><span class="line">ms-dns  8.8.4.4</span><br><span class="line"><span class="comment"># ms-dns  192.168.1.1</span></span><br><span class="line"><span class="comment"># ms-dns  192.168.1.3</span></span><br><span class="line"><span class="comment"># ms-wins 192.168.1.2</span></span><br><span class="line"><span class="comment"># ms-wins 192.168.1.4</span></span><br><span class="line">name l2tpd</span><br><span class="line">noccp</span><br><span class="line">auth</span><br><span class="line"><span class="comment">#obsolete: crtscts</span></span><br><span class="line">crtscts</span><br><span class="line">idle 1800</span><br><span class="line">mtu 1410</span><br><span class="line">mru 1410</span><br><span class="line">nodefaultroute</span><br><span class="line">debug</span><br><span class="line"><span class="comment">#obsolete: lock</span></span><br><span class="line">lock</span><br><span class="line">proxyarp</span><br><span class="line">connect-delay 5000</span><br><span class="line"><span class="comment"># To allow authentication against a Windows domain EXAMPLE, and require the</span></span><br><span class="line"><span class="comment"># user to be in a group &quot;VPN Users&quot;. Requires the samba-winbind package</span></span><br><span class="line"><span class="comment"># require-mschap-v2</span></span><br><span class="line"><span class="comment"># plugin winbind.so</span></span><br><span class="line"><span class="comment"># ntlm_auth-helper &#x27;/usr/bin/ntlm_auth --helper-protocol=ntlm-server-1 --require-membership-of=&quot;EXAMPLE\\VPN Users&quot;&#x27; </span></span><br><span class="line"><span class="comment"># You need to join the domain on the server, for example using samba:</span></span><br><span class="line"><span class="comment"># http://rootmanager.com/ubuntu-ipsec-l2tp-windows-domain-auth/setting-up-openswan-xl2tpd-with-native-windows-clients-lucid.html</span></span><br><span class="line"></span><br><span class="line">refuse-pap</span><br><span class="line">refuse-chap</span><br><span class="line">refuse-mschap</span><br><span class="line">require-mschap-v2 <span class="comment"># Windows连接必须设置</span></span><br><span class="line">persist</span><br><span class="line">logfile /var/<span class="built_in">log</span>/xl2tpd.log</span><br></pre></td></tr></table></figure>

<h3 id="IPsec"><a href="#IPsec" class="headerlink" title="IPsec"></a>IPsec</h3><p>主配置文件<code>/etc/ipsec.conf</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/ipsec.conf - Libreswan IPsec configuration file</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># see &#x27;man ipsec.conf&#x27; and &#x27;man pluto&#x27; for more information</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For example configurations and documentation, see https://libreswan.org/wiki/</span></span><br><span class="line"></span><br><span class="line">config setup</span><br><span class="line">        protostack=netkey</span><br><span class="line">        dumpdir=/var/run/pluto/</span><br><span class="line">        <span class="comment"># Normally, pluto logs via syslog.</span></span><br><span class="line">        <span class="comment">#logfile=/var/log/pluto.log</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># Do not enable debug options to debug configuration issues!</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># plutodebug=&quot;control parsing&quot;</span></span><br><span class="line">        <span class="comment"># plutodebug=&quot;all crypt&quot;</span></span><br><span class="line">        <span class="comment"># plutodebug=none</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># NAT-TRAVERSAL support</span></span><br><span class="line">        <span class="comment"># exclude networks used on server side by adding %v4:!a.b.c.0/24</span></span><br><span class="line">        <span class="comment"># It seems that T-Mobile in the US and Rogers/Fido in Canada are</span></span><br><span class="line">        <span class="comment"># using 25/8 as &quot;private&quot; address space on their wireless networks.</span></span><br><span class="line">        <span class="comment"># This range has never been announced via BGP (at least up to 2015)</span></span><br><span class="line">        virtual_private=%v4:10.0.0.0/8,%v4:192.168.0.0/16,%v4:172.16.0.0/12,%v4:25.0.0.0/8,%v4:100.64.0.0/10,%v6:fd00::/8,%v6:fe80::/10</span><br><span class="line"></span><br><span class="line"><span class="comment"># if it exists, include system wide crypto-policy defaults</span></span><br><span class="line"><span class="comment"># include /etc/crypto-policies/back-ends/libreswan.config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># It is best to add your IPsec connections as separate files in /etc/ipsec.d/</span></span><br><span class="line">include /etc/ipsec.d/*.conf</span><br></pre></td></tr></table></figure>

<p>:::info</p>
<ul>
<li>第一行config setup必须左对齐，即前面不能有空格，否则会报错</li>
<li>其他每一行都必须以Tab开头，否则会报错</li>
<li>如果安装的是 openswan，可能需要在 config setup 之前添加 version 2.0<br>:::</li>
</ul>
<p>在<code>/etc/ipsec.secrets</code>中设置PSK密钥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 格式为 服务器IP %any: PSK “预共享密钥”，其中 %any: 和 PSK 之间有空格</span></span><br><span class="line">[服务器外网IP] %any: PSK <span class="string">&quot;123456abcdefg&quot;</span></span><br></pre></td></tr></table></figure>

<p>接着继续配置服务器, 修改配置文件<code>/etc/ipsec.d/l2tp-ipsec.conf</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">conn L2TP-PSK-NAT</span><br><span class="line">    rightsubnet=vhost:%priv</span><br><span class="line">    dpddelay=10</span><br><span class="line">    dpdtimeout=20</span><br><span class="line">    dpdaction=clear</span><br><span class="line">    forceencaps=yes</span><br><span class="line">    also=L2TP-PSK-noNAT</span><br><span class="line">conn L2TP-PSK-noNAT</span><br><span class="line">    authby=secret</span><br><span class="line">    pfs=no</span><br><span class="line">    auto=add</span><br><span class="line">    keyingtries=3</span><br><span class="line">    rekey=no</span><br><span class="line">    ikelifetime=8h</span><br><span class="line">    keylife=1h</span><br><span class="line">    <span class="built_in">type</span>=transport</span><br><span class="line">    left=1.14.239.60</span><br><span class="line">    leftprotoport=17/1701</span><br><span class="line">    right=%any</span><br><span class="line">    rightprotoport=17/%any</span><br></pre></td></tr></table></figure>

<p>:::info</p>
<ul>
<li>conn开头的两行必须左对齐，开头不能有空格，其他每一行必须以Tab缩进</li>
<li>left 此时也要填服务器的外网IP<br>:::</li>
</ul>
<h3 id="添加账号密码"><a href="#添加账号密码" class="headerlink" title="添加账号密码"></a>添加账号密码</h3><p>配置文件<code>/etc/ppp/chap-secrets</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Secrets for authentication using CHAP</span></span><br><span class="line"><span class="comment"># client        server  secret                  IP addresses</span></span><br><span class="line">vpntest l2tpd 123456 192.168.100.129</span><br></pre></td></tr></table></figure>

<p>这里我习惯性的给用户指定固定IP, 方便管理, 如果你是使用<code>*</code>代替, 那就会自动分配指定段的IP地址</p>
<h3 id="开启内核转发"><a href="#开启内核转发" class="headerlink" title="开启内核转发"></a>开启内核转发</h3><p>配置文件<code>/etc/sysctl.conf</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Kernel sysctl configuration file for Red Hat Linux</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For binary values, 0 is disabled, 1 is enabled.  See sysctl(8) and</span></span><br><span class="line"><span class="comment"># sysctl.conf(5) for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Use &#x27;/sbin/sysctl -a&#x27; to list all possible parameters.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Controls IP packet forwarding</span></span><br><span class="line">net.ipv4.ip_forward = 1            <span class="comment">#此处的值改为1，开启内核转发</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Controls source route verification</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Do not accept source routing</span></span><br><span class="line">net.ipv4.conf.default.accept_source_route = 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Controls the System Request debugging functionality of the kernel</span></span><br><span class="line">kernel.sysrq = 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Controls whether core dumps will append the PID to the core filename.</span></span><br><span class="line"><span class="comment"># Useful for debugging multi-threaded applications.</span></span><br><span class="line">kernel.core_uses_pid = 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Controls the use of TCP syncookies</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Controls the default maxmimum size of a mesage queue</span></span><br><span class="line">kernel.msgmnb = 65536</span><br><span class="line"></span><br><span class="line"><span class="comment"># Controls the maximum size of a message, in bytes</span></span><br><span class="line">kernel.msgmax = 65536</span><br><span class="line"></span><br><span class="line"><span class="comment"># Controls the maximum shared segment size, in bytes</span></span><br><span class="line">kernel.shmmax = 68719476736</span><br><span class="line"></span><br><span class="line"><span class="comment"># Controls the maximum number of shared memory segments, in pages</span></span><br><span class="line">kernel.shmall = 4294967296</span><br><span class="line"></span><br><span class="line">vm.swappiness = 0</span><br><span class="line">net.ipv4.neigh.default.gc_stale_time = 120</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># see details in https://help.aliyun.com/knowledge_detail/39428.html</span></span><br><span class="line">net.ipv4.conf.all.rp_filter = 0</span><br><span class="line">net.ipv4.conf.default.rp_filter = 0                <span class="comment">#此处的值必须是0</span></span><br><span class="line">net.ipv4.conf.default.arp_announce = 2</span><br><span class="line">net.ipv4.conf.lo.arp_announce=2</span><br><span class="line">net.ipv4.conf.all.arp_announce=2</span><br><span class="line">net.ipv4.conf.all.send_redirects = 0               <span class="comment">#添加这几行</span></span><br><span class="line">net.ipv4.conf.default.send_redirects = 0           <span class="comment">#添加这几行</span></span><br><span class="line">net.ipv4.conf.all.log_martians = 0                 <span class="comment">#添加这几行</span></span><br><span class="line">net.ipv4.conf.default.log_martians = 0             <span class="comment">#添加这几行</span></span><br><span class="line">net.ipv4.conf.all.accept_redirects = 0             <span class="comment">#添加这几行</span></span><br><span class="line">net.ipv4.conf.default.accept_redirects = 0         <span class="comment">#添加这几行</span></span><br><span class="line">net.ipv4.icmp_ignore_bogus_error_responses = 1     <span class="comment">#添加这几行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># see details in https://help.aliyun.com/knowledge_detail/41334.html</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 1024</span><br><span class="line">net.ipv4.tcp_synack_retries = 2</span><br></pre></td></tr></table></figure>

<p>完了, 重载内核配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<h3 id="配置ip转发"><a href="#配置ip转发" class="headerlink" title="配置ip转发"></a>配置ip转发</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## ip为服务器内网ip</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -o eth1 -j MASQUERADE</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看nat配置</span></span><br><span class="line">iptables -t nat -L -n</span><br></pre></td></tr></table></figure>

<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## xl2tpd debug 模式, 可以实时查看运行日志</span></span><br><span class="line">xl2tpd -D</span><br><span class="line"></span><br><span class="line"><span class="comment">## IPsec状态检验, 如果有[FAILED]就不行, 需要对症解决</span></span><br><span class="line">ipsec verify</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动</span></span><br><span class="line">systemctl start ipsec</span><br><span class="line">systemctl start xl2tpd</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看状态</span></span><br><span class="line">systemctl status ipsec</span><br><span class="line">systemctl status xl2tpd</span><br><span class="line"></span><br><span class="line"><span class="comment">## 设置开机启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span> ipsec</span><br><span class="line">systemctl <span class="built_in">enable</span> xl2tpd</span><br></pre></td></tr></table></figure>

<h2 id="Windows客户端配置"><a href="#Windows客户端配置" class="headerlink" title="Windows客户端配置"></a>Windows客户端配置</h2><ol>
<li><code>windows+r</code>打开运行，输入<code>services.msc</code>，查找<code>ipsec policy agent</code>，启用服务</li>
<li>打开注册表，路径<code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\Rasman\Parameters</code><ul>
<li>添加DWORD值(32位)值，名称<code>ProhibitIpSec</code>，值为 1</li>
<li>由于缺省的 Windows XP L2TP 传输策略不允许不使用 IPSec 加密的 L2TP 传输，修改<code>AllowL2TPWeakCrypto</code>的值为<code>1</code></li>
<li>重启电脑</li>
</ul>
</li>
</ol>
<h2 id="Linux客户端配置"><a href="#Linux客户端配置" class="headerlink" title="Linux客户端配置"></a>Linux客户端配置</h2><blockquote>
<p>以Centos 7为例</p>
</blockquote>
<ol>
<li>安装 VPN 客户端</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install strongswan xl2tpd</span><br><span class="line"></span><br><span class="line"><span class="comment">## 设置 VPN 变量</span></span><br><span class="line">VPN_SERVER_IP=<span class="string">&#x27;VPN服务器IP&#x27;</span> </span><br><span class="line">VPN_IPSEC_PSK=<span class="string">&#x27;PSK密钥&#x27;</span> </span><br><span class="line">VPN_USERNAME=<span class="string">&#x27;用户名&#x27;</span> </span><br><span class="line">VPN_PASSWORD=<span class="string">&#x27;密码&#x27;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>配置strongSwan</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/ipsec.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"># ipsec.conf - strongSwan IPsec configuration file</span></span><br><span class="line"><span class="string"># basic configuration</span></span><br><span class="line"><span class="string">config setup</span></span><br><span class="line"><span class="string"> # strictcrlpolicy=yes</span></span><br><span class="line"><span class="string"> # uniqueids = no</span></span><br><span class="line"><span class="string"># Add connections here.</span></span><br><span class="line"><span class="string"># Sample VPN connections</span></span><br><span class="line"><span class="string">conn %default</span></span><br><span class="line"><span class="string"> ikelifetime=60m</span></span><br><span class="line"><span class="string"> keylife=20m</span></span><br><span class="line"><span class="string"> rekeymargin=3m</span></span><br><span class="line"><span class="string"> keyingtries=1</span></span><br><span class="line"><span class="string"> keyexchange=ikev1</span></span><br><span class="line"><span class="string"> authby=secret</span></span><br><span class="line"><span class="string"> ike=aes128-sha1-modp1024,3des-sha1-modp1024!</span></span><br><span class="line"><span class="string"> esp=aes128-sha1-modp1024,3des-sha1-modp1024!</span></span><br><span class="line"><span class="string">conn myvpn</span></span><br><span class="line"><span class="string"> keyexchange=ikev1</span></span><br><span class="line"><span class="string"> left=%defaultroute</span></span><br><span class="line"><span class="string"> auto=add</span></span><br><span class="line"><span class="string"> authby=secret</span></span><br><span class="line"><span class="string"> type=transport</span></span><br><span class="line"><span class="string"> leftprotoport=17/1701</span></span><br><span class="line"><span class="string"> rightprotoport=17/1701</span></span><br><span class="line"><span class="string"> right=$VPN_SERVER_IP</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">cat &gt; /etc/ipsec.secrets &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">: PSK &quot;$VPN_IPSEC_PSK&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">chmod 600 /etc/ipsec.secrets</span><br><span class="line"><span class="comment"># For CentOS/RHEL &amp; Fedora ONLY</span></span><br><span class="line">mv /etc/strongswan/ipsec.conf /etc/strongswan/ipsec.conf.old 2&gt;/dev/null</span><br><span class="line">mv /etc/strongswan/ipsec.secrets /etc/strongswan/ipsec.secrets.old 2&gt;/dev/null</span><br><span class="line">ln -s /etc/ipsec.conf /etc/strongswan/ipsec.conf</span><br><span class="line">ln -s /etc/ipsec.secrets /etc/strongswan/ipsec.secrets</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>配置xl2tpd</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/xl2tpd/xl2tpd.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[lac myvpn]</span></span><br><span class="line"><span class="string">lns = $VPN_SERVER_IP</span></span><br><span class="line"><span class="string">ppp debug = yes</span></span><br><span class="line"><span class="string">pppoptfile = /etc/ppp/options.l2tpd.client</span></span><br><span class="line"><span class="string">length bit = yes</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">cat &gt; /etc/ppp/options.l2tpd.client &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">ipcp-accept-local</span></span><br><span class="line"><span class="string">ipcp-accept-remote</span></span><br><span class="line"><span class="string">refuse-eap</span></span><br><span class="line"><span class="string">require-chap</span></span><br><span class="line"><span class="string">noccp</span></span><br><span class="line"><span class="string">noauth</span></span><br><span class="line"><span class="string">mtu 1280</span></span><br><span class="line"><span class="string">mru 1280</span></span><br><span class="line"><span class="string">noipdefault</span></span><br><span class="line"><span class="string">defaultroute</span></span><br><span class="line"><span class="string">usepeerdns</span></span><br><span class="line"><span class="string">connect-delay 5000</span></span><br><span class="line"><span class="string">name $VPN_USER</span></span><br><span class="line"><span class="string">password $VPN_PASSWORD</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">chmod 600 /etc/ppp/options.l2tpd.client</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>连接VPN</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/run/xl2tpd</span><br><span class="line">touch /var/run/xl2tpd/l2tp-control </span><br><span class="line">service strongswan restart</span><br><span class="line">service xl2tpd restart</span><br><span class="line"></span><br><span class="line"><span class="comment">## 连接VPN</span></span><br><span class="line">strongswan up myvpn</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;c myvpn&quot;</span> &gt; /var/run/xl2tpd/l2tp-control</span><br><span class="line"></span><br><span class="line"><span class="comment">## 断开VPN</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;d myvpn&quot;</span> &gt; /var/run/xl2tpd/l2tp-control</span><br><span class="line">strongswan down myvpn</span><br></pre></td></tr></table></figure>

<h2 id="扩展知识"><a href="#扩展知识" class="headerlink" title="扩展知识"></a>扩展知识</h2><p>比较一下现在主流VPN协议的优缺点</p>
<h3 id="PPTP"><a href="#PPTP" class="headerlink" title="PPTP"></a>PPTP</h3><p>点对点隧道协议（英语：Point to Point Tunneling Protocol，缩写为PPTP）是实现虚拟专用网（VPN）的方式之一。PPTP使用传输控制协议（TCP）创建控制通道来发送控制命令，以及利用通用路由封装（GRE）通道来封装点对点协议（PPP）数据包以发送资料。这个协议最早由微软等厂商主导开发，但因为它的加密方式容易被破解，微软已经不再建议使用这个协议。</p>
<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul>
<li>速度快</li>
<li>几乎所有平台都内置</li>
<li>配置极为简单</li>
</ul>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>受到美国国安局威胁</li>
<li>不安全</li>
</ul>
<h3 id="L2TP-and-L2TP-IPsec"><a href="#L2TP-and-L2TP-IPsec" class="headerlink" title="L2TP and L2TP/IPsec"></a>L2TP and L2TP/IPsec</h3><h4 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h4><ul>
<li>可供所有现代的设备及操作系统使用</li>
<li>容易设定</li>
</ul>
<h4 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>比OpenVPN慢</li>
<li>可能受到美国国安局的威胁</li>
<li>与限制力强的防火请一起使用会有问题</li>
<li>美国国安局极有可能已经削弱这个协议的能力</li>
</ul>
<h3 id="OpenVPN"><a href="#OpenVPN" class="headerlink" title="OpenVPN"></a>OpenVPN</h3><p>OpenVPN是一个用于创建虚拟私人网络加密通道的软件包，最早由James Yonan编写。OpenVPN允许创建的VPN使用公开密钥、电子证书、或者用户名／密码来进行身份验证。</p>
<p>它大量使用了OpenSSL加密库中的SSL/TLS协议函数库。</p>
<p>OpenVPN的技术核心是虚拟网卡，其次是SSL协议实现。</p>
<h4 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h4><ul>
<li>具备能跨越大多数防火墙的能力</li>
<li>高度可配置</li>
<li>因为是开放资源，所以可以轻松修正后门</li>
<li>能使用各种加密功能运算法</li>
<li>高度安全性</li>
</ul>
<h4 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>设定起来有点棘手</li>
<li>需要用到第三方软件</li>
<li>桌面电脑支援做得好，可是流动设备的则需要改进</li>
</ul>
<h3 id="SSTP"><a href="#SSTP" class="headerlink" title="SSTP"></a>SSTP</h3><p>SSTP可以创建一个在HTTPS上传送的VPN隧道，从而消除与基于PPTP（点对点隧道协议）或L2TP（第2层隧道协议）VPN连接有关的诸多问题。因为这些协议有可能受到某些位于客户端与服务器之间的Web代理、防火墙和网络地址转换（NAT）路由器的阻拦。</p>
<p>这种SSTP只适用于远程访问，不能支持站点与站点之间的VPN隧道。</p>
<h4 id="优点-3"><a href="#优点-3" class="headerlink" title="优点"></a>优点</h4><ul>
<li>具备越过大多数防火墙的能力</li>
<li>安全标准取决与密码，但一般来说是安全的</li>
<li>能完全融入Windows操作系统</li>
<li>微软支援</li>
</ul>
<h4 id="缺点-3"><a href="#缺点-3" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>因为是专利标准是由微软公司持有，因此不能修正后门</li>
<li>只能在Windows平台上操作</li>
</ul>
<h3 id="IKEv2"><a href="#IKEv2" class="headerlink" title="IKEv2"></a>IKEv2</h3><p>因特网密钥交换（英语：Internet Key Exchange，简称IKE或IKEv2）是一种网络协议，归属于IPsec协议族，用以创建安全关系（Security association，SA）。它创建在奥克利协议（Oakley protocol）与ISAKMP协议的基础之上。</p>
<h4 id="优点-4"><a href="#优点-4" class="headerlink" title="优点"></a>优点</h4><ul>
<li>极度安全–支援各种密码如3DES、 AES、 AES 256等</li>
<li>支援黑莓设备</li>
<li>稳定，特别是在连接中断或者是交换网络使用时更是如此</li>
<li>容易设定，至少从用户终端是如此</li>
<li>比 L2TP、PPTP 及 SSTP相对更快速</li>
</ul>
<h4 id="缺点-4"><a href="#缺点-4" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>支援平台有限</li>
<li>为基础的方案像是SSTP或OpenVPN而较容易被阻挡，因为使用UDP 端口500</li>
<li>不是开放资源实现方案</li>
<li>在非服务器端施用IKEv2比较棘手，能导致一些潜在问题</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%AC%AC%E4%BA%8C%E5%B1%82%E9%9A%A7%E9%81%93%E5%8D%8F%E8%AE%AE">第二层隧道协议</a></li>
<li><a target="_blank" rel="noopener" href="https://www.wenjinyu.me/zh/centos-7-build-l2tp-vpn/#%E5%87%86%E5%A4%87">CentOS 7搭建L2TP VPN</a></li>
<li><a target="_blank" rel="noopener" href="https://www.linuxprobe.com/centos7-install-l2tp.html">CentOS7 搭建L2TP</a></li>
<li><a target="_blank" rel="noopener" href="https://imkira.com/CentOS7-L2TP-IPsec-VPN/">Centos7 搭建 L2TP+ IPsec VPN</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44901564/article/details/106619826">L2TP连接尝试失败，因为安全层再初始化与远程计算机的协商时遇到一个处理错误</a></li>
<li><a target="_blank" rel="noopener" href="https://zh.vpnmentor.com/blog/%e6%af%94%e8%be%83vpn%e5%8d%8f%e8%ae%ae-pptp-%e5%af%b9-l2tp-%e5%af%b9-openvpn-%e5%af%b9sstp-%e5%af%b9-ikev2/">比较VPN协议: PPTP 对 L2TP 对 OpenVPN 对SSTP 对 IKEv2</a></li>
<li><a target="_blank" rel="noopener" href="https://www.myip.io/how-to-details/configure-l2tp-centos">Configuring L2TP connection on Centos 7</a></li>
</ul>

                    </article>
                    
    <blockquote class="post-license">
        <p>
            <strong>本文作者&nbsp;:&nbsp;Kevalin</strong>
            <br>
            <strong>
            
                本文使用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)</a> 协议
            </strong>
            <br>
            <strong>本文链接&nbsp;:&nbsp;</strong><a href="https://kevalin.github.io/2023/02/22/Centos7-%E6%90%AD%E5%BB%BAL2TP-IPsec-VPN/">https://kevalin.github.io/2023/02/22/Centos7-%E6%90%AD%E5%BB%BAL2TP-IPsec-VPN/</a>
        </p>
    </blockquote>




<p class="post-footer-info mb-0 pt-0">本文发表于&nbsp;<time datetime="2023-02-22T15:27:20.000Z" itemprop="datePublished">2023-02-22</time>

</p>
<p class="post-footer-info mb-0 pt-2">



<span class="post-tags-list mt-2">

<a class="post-tags-list-item" href="/tags/Linux/" rel="tag">#&nbsp;Linux</a>

<a class="post-tags-list-item" href="/tags/VPN/" rel="tag">#&nbsp;VPN</a>

</span>


</p>

                </div>
                <div class="post-nav px-2 bg-gray">
<ul class="pagination">
    <!-- Prev Nav -->
    
        <li class="page-item page-prev">
            <a href="/2023/02/22/rsync/" rel="prev">
                <div class="page-item-title"><i class="icon icon-back" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">rsync</div>
            </a>
        </li>
    

    <!-- Next Nav -->
    
        <li class="page-item page-next">
            <a href="/2023/02/22/ksmd-%E5%8D%A0%E7%94%A8%E5%A4%AA%E5%A4%9A-CPU-%E8%B5%84%E6%BA%90/" rel="next">
                <div class="page-item-title"><i class="icon icon-forward" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">ksmd 占用太多 CPU 资源</div>
            </a>
        </li>
    
</ul>
</div>

                
                    <!-- # Comment # -->
                    
                        <div class="card-footer post-comment">
                            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
        this.page.url = 'https://kevalin.github.io/2023/02/22/Centos7-%E6%90%AD%E5%BB%BAL2TP-IPsec-VPN/'; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'https://kevalin.github.io/2023/02/22/Centos7-%E6%90%AD%E5%BB%BAL2TP-IPsec-VPN/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>
<script id="disqus-thread-script">
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//kevalin-github-io-1.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

                        </div>
                    
                
            </div>
        </div>
    </div>
</div>

            <!-- ### Footer ### -->
            <footer class="text-center">
    <!-- footer copyright -->
    
        <p class="footer-copyright mb-0">Copyright&nbsp;©&nbsp;<span id="copyright-year"></span>
            <a class="footer-copyright-a" href="https://kevalin.github.io">举个栗子</a>
        </p>

    <!-- footer custom text -->
    <p class="footer-text mb-0">
    
    </p>
    <!-- footer develop info -->
    <p class="footer-develop mb-0">
        
    <!-- Busuanzi User Views -->
    <span id="busuanzi_container_site_uv" hidden>
        <span></span>
        <span id="busuanzi_value_site_uv"></span>
        <span>Viewers</span>
        
            <span>|</span>
        
    </span>




        
        Powered by&nbsp;<!--
         --><a href="https://hexo.io" target="_blank" class="footer-develop-a" rel="external nofollow noopener noreferrer">Hexo</a><span class="footer-develop-divider"></span>Theme&nbsp;-&nbsp;<!--
         --><a href="https://github.com/SukkaW/hexo-theme-suka" target="_blank" class="footer-develop-a" rel="external noopener">Suka</a>
    </p>
</footer>


        <!-- ### Import File ### -->
        <!-- ### Footer JS Import ### -->

<script>

    
window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 50
};

(function() {
    var copyrightNow = new Date().getFullYear();
    var copyrightContent = document.getElementById('copyright-year');
    var copyrightSince = 2016;
    if (copyrightSince === copyrightNow) {
        copyrightContent.textContent = copyrightNow;
    } else {
        copyrightContent.textContent = copyrightSince + ' - ' + copyrightNow;
    }
})();
console.log('\n %c Suka Theme (hexo-theme-suka) | © SukkaW | Verision 1.3.3 %c https://github.com/SukkaW/hexo-theme-suka \n', 'color: #fff; background: #444; padding:5px 0;', 'background: #bbb; padding:5px 0;');

</script>

<script src="/lib/vanilla-lazyload/lazyload.min.js" async></script>
    <script src="https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js" async></script>


<!-- Offset -->




<!-- Comment -->

    
        <script id="dsq-count-scr" src="https://kevalin-github-io-1.disqus.com/count.js" async></script>

    


<!-- ### Custom Footer ### -->

    </body>

</html>